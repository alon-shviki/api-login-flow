services:
  # --- TiDB Placement Driver (Brain) ---
  pd:
    image: pingcap/pd:v7.5.1
    container_name: pd
    networks: [api-network]
    command:
      [
        "--name=pd",
        "--data-dir=/data",
        "--client-urls=http://0.0.0.0:2379",
        "--advertise-client-urls=http://pd:2379",
      ]

  # --- TiKV Storage Engine ---
  tikv:
    image: pingcap/tikv:v7.5.1
    container_name: tikv
    networks: [api-network]
    command:
      [
        "--pd-endpoints=http://pd:2379",
        "--addr=0.0.0.0:20160",
        "--advertise-addr=tikv:20160",
        "--data-dir=/data",
      ]
    depends_on: [pd]

  # --- TiDB SQL Layer ---
  tidb:
    image: pingcap/tidb:v7.5.1
    container_name: tidb-db
    ports:
      - "4000:4000"
    volumes:
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks: [api-network]
    command: ["--store=tikv", "--path=pd:2379"]
    depends_on:
      - tikv
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "timeout 1s bash -c 'cat < /dev/null > /dev/tcp/127.0.0.1/4000'",
        ]
      interval: 10s
      timeout: 10s
      retries: 20
      start_period: 60s

  # --- Kafka Messaging ---
  kafka:
    image: apache/kafka:latest
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_NUM_PARTITIONS=3 
    networks: [api-network]

  # --- TiCDC (Change Data Capture) 
  ticdc:
    image: pingcap/ticdc:v7.5.1
    container_name: ticdc
    networks: [api-network]
    command:
      - /cdc
      - server
      - --addr=0.0.0.0:8300
      - --advertise-addr=ticdc:8300
      - --pd=http://pd:2379
      - --log-file=/dev/stdout
    depends_on:
      - pd
      - tidb

  # --- CDC Initializer: Automatically creates the changefeed 
  cdc-init:
    image: pingcap/ticdc:v7.5.1
    networks: [api-network]
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Waiting for TiCDC to be ready on port 8300..."
        while ! nc -z ticdc 8300; do sleep 2; done
        echo "TiCDC ready. Checking/creating changefeed..."
        if /cdc cli changefeed list --server=http://ticdc:8300 | grep -q "db-changes-changefeed"; then
          echo "Changefeed 'db-changes-changefeed' already exists."
        else
          echo "Creating changefeed to Kafka topic 'db-changes'..."
          /cdc cli changefeed create \
            --server=http://ticdc:8300 \
            --changefeed-id=db-changes-changefeed \
            --sink-uri="kafka://kafka:9092/db-changes?protocol=canal-json&replication-factor=1"
          echo "Changefeed created successfully."
        fi
        echo "CDC setup complete."
    depends_on:
      - ticdc
      - kafka

  # --- Backend API ---
  backend:
    build: ./backend
    container_name: login-api
    ports:
      - "3001:3001"
    depends_on:
      tidb:
        condition: service_healthy
      kafka:
        condition: service_started
    networks: [api-network]

  # --- Login Event Kafka Worker ---
  worker:
    build: ./backend
    container_name: login-worker
    command: node worker.js
    depends_on: [kafka]
    networks: [api-network]

  # --- CDC Kafka Worker (Database Change Consumer) ---
  cdc-worker:
    build: ./backend
    container_name: cdc-worker
    command: node cdc-worker.js
    # CHANGED: Added proper startup ordering to avoid race conditions
    # - Wait for TiDB to be healthy
    # - Wait for Kafka to be started
    # - Wait for cdc-init to finish creating the changefeed
    depends_on:
      tidb:
        condition: service_healthy  # Wait for TiDB to be fully ready
      kafka:
        condition: service_started    # Kafka started
      cdc-init:
        condition: service_completed_successfully  # Wait for changefeed creation
    networks: [api-network]

  # --- Frontend UI ---
  login-ui:
    build: ./frontend
    container_name: login-ui
    ports:
      - "8080:80"
    networks: [api-network]

networks:
  api-network:
    driver: bridge